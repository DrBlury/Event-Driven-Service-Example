---
# Pre-commit hooks for Event-Driven-Service-Example
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files
# Update hooks: pre-commit autoupdate

default_stages: [pre-commit]
fail_fast: false

repos:
  # =============================================================================
  # General Hooks - File hygiene and basic checks
  # =============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      # Prevent giant files from being committed
      - id: check-added-large-files
        args: ["--maxkb=1000"]

      # Check for files that would conflict in case-insensitive filesystems
      - id: check-case-conflict

      # Check for merge conflict markers
      - id: check-merge-conflict

      # Ensure files end with a newline
      - id: end-of-file-fixer
        exclude: ^(api/bundle\.yml|.*\.gen\.go|.*_gen\.go)$

      # Trim trailing whitespace
      - id: trailing-whitespace
        exclude: ^(api/bundle\.yml|.*\.gen\.go|.*_gen\.go)$

      # Check YAML syntax
      - id: check-yaml
        args: ["--allow-multiple-documents"]
        exclude: ^(api/.*|infra/compose/.*)$

      # Check JSON syntax
      - id: check-json
        exclude: ^(sbom/.*|.*\.gen\.json)$

      # Check TOML syntax
      - id: check-toml

      # Detect private keys
      - id: detect-private-key

      # Check executables have shebangs
      - id: check-executables-have-shebangs

      # Check shebang scripts are executable
      - id: check-shebang-scripts-are-executable

      # Prevent committing directly to main/master
      - id: no-commit-to-branch
        args: ["--branch", "main", "--branch", "master"]

  # =============================================================================
  # Go Hooks - Linting, formatting, and module management
  # =============================================================================
  - repo: https://github.com/golangci/golangci-lint
    rev: v2.6.2
    hooks:
      - id: golangci-lint
        name: golangci-lint (src)
        entry: golangci-lint run --config src/.golangci.yml
        files: ^src/.*\.go$
        types: [go]

  # TekWizely/pre-commit-golang - actively maintained, feature-rich Go hooks
  - repo: https://github.com/TekWizely/pre-commit-golang
    rev: v1.0.0-rc.4
    hooks:
      - id: go-fmt
        name: go-fmt (src)
        files: ^src/.*\.go$

      - id: go-mod-tidy
        name: go-mod-tidy (src)
        files: ^src/go\.(mod|sum)$

  # Go imports organization
  - repo: https://github.com/incu6us/goimports-reviser
    rev: v3.11.0
    hooks:
      - id: goimports-reviser
        name: goimports-reviser (src)
        args:
          - -rm-unused
          - -set-alias
          - -format
          - -company-prefixes=drblury
        files: ^src/.*\.go$
        exclude: ^src/.*(_gen|\.gen)\.go$

  # =============================================================================
  # Security Hooks - Secret detection and vulnerability scanning
  # NOTE: Both gitleaks and trufflehog are kept for defense in depth:
  # - gitleaks: Fast, local pattern matching, catches common patterns
  # - trufflehog: Verifies against live services, higher accuracy for API keys
  # =============================================================================
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.30.0
    hooks:
      - id: gitleaks
        name: gitleaks (detect secrets)

  - repo: https://github.com/trufflesecurity/trufflehog
    rev: v3.91.1
    hooks:
      - id: trufflehog
        name: trufflehog (verify secrets)
        entry: trufflehog git file://. --only-verified --fail
        args: []

  # =============================================================================
  # Dockerfile Hooks - Linting Dockerfiles
  # =============================================================================
  - repo: https://github.com/hadolint/hadolint
    rev: v2.14.0
    hooks:
      - id: hadolint-docker
        name: hadolint (Dockerfile linting)
        files: (Dockerfile|\.dockerfile)$

  # =============================================================================
  # YAML/JSON Hooks - Formatting and validation
  # =============================================================================
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.37.1
    hooks:
      - id: yamllint
        name: yamllint
        args:
          - -c
          - .yamllint.yml
        exclude: ^(api/.*|infra/compose/.*|_volume_data/.*)$

  # rbubley/mirrors-prettier - actively maintained fork
  - repo: https://github.com/rbubley/mirrors-prettier
    rev: v3.7.3
    hooks:
      - id: prettier
        name: prettier (json/yaml/md)
        types_or: [json, markdown]
        exclude: ^(sbom/.*|api/bundle\.yml|_volume_data/.*)$

  # =============================================================================
  # Shell Script Hooks - Linting shell scripts
  # =============================================================================
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.10.0.1
    hooks:
      - id: shellcheck
        name: shellcheck (shell scripts)
        args: ["--severity=warning"]

  # =============================================================================
  # Protobuf Hooks - Buf linting
  # =============================================================================
  - repo: https://github.com/bufbuild/buf
    rev: v1.61.0
    hooks:
      - id: buf-lint
        name: buf lint (protobuf)
        args: ["--config", "proto/buf.yaml"]
        files: ^proto/.*\.proto$

  # =============================================================================
  # Terraform Hooks - Infrastructure as Code validation
  # =============================================================================
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.104.0
    hooks:
      - id: terraform_fmt
        name: terraform fmt
        files: ^infra/terraform/.*\.tf$

      - id: terraform_validate
        name: terraform validate
        files: ^infra/terraform/.*\.tf$

      - id: terraform_tflint
        name: terraform tflint
        files: ^infra/terraform/.*\.tf$
        args:
          - "--args=--only=terraform_deprecated_interpolation"
          - "--args=--only=terraform_deprecated_index"
          - "--args=--only=terraform_unused_declarations"
          - "--args=--only=terraform_comment_syntax"
          - "--args=--only=terraform_naming_convention"
          - "--args=--only=terraform_required_version"
          - "--args=--only=terraform_required_providers"

  # =============================================================================
  # GitHub Actions Hooks - Workflow validation
  # =============================================================================
  - repo: https://github.com/rhysd/actionlint
    rev: v1.7.9
    hooks:
      - id: actionlint
        name: actionlint (GitHub Actions)
        files: ^\.github/workflows/.*\.ya?ml$

  # =============================================================================
  # Markdown Hooks - Documentation linting
  # =============================================================================
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.46.0
    hooks:
      - id: markdownlint
        name: markdownlint
        args: ["--fix", "--disable", "MD013", "MD033", "MD041", "--"]
        exclude: ^(LICENSE|CHANGELOG).*$

  # =============================================================================
  # Commit Message Hooks - Conventional commits
  # =============================================================================
  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v4.3.0
    hooks:
      - id: conventional-pre-commit
        name: conventional-pre-commit
        stages: [commit-msg]
        args:
          - feat
          - fix
          - docs
          - style
          - refactor
          - perf
          - test
          - build
          - ci
          - chore
          - revert

  # =============================================================================
  # Code Metrics Hooks - Generate SCC statistics
  # =============================================================================
  - repo: local
    hooks:
      - id: generate-scc-report
        name: generate-scc-report (code metrics)
        entry: scripts/generate-scc-report.sh
        language: script
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
