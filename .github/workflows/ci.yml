# Main CI workflow - uses modular reusable workflows
# Generated code (protobuf, OpenAPI) is committed to the repo for simplicity
name: Service CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ============================================
  # Verify Generated Code is Up-to-Date
  # ============================================
  verify-generated:
    name: Verify Generated Code
    permissions:
      contents: write
    uses: ./.github/workflows/reusable-verify-generated.yml
    with:
      auto-commit: true
    secrets:
      github-token: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Go Module Lint & Build
  # ============================================
  go-lint-build:
    name: Go Lint & Build
    uses: ./.github/workflows/reusable-go-lint-build.yml
    with:
      go-version-file: src/go.mod
      cache-dependency-path: src/go.sum
      working-directory: src

  # ============================================
  # Go Tests with Coverage
  # ============================================
  go-test:
    name: Go Test
    uses: ./.github/workflows/reusable-go-test.yml
    with:
      go-version-file: src/go.mod
      cache-dependency-path: src/go.sum
      working-directory: src
      upload-codecov: true
    secrets:
      codecov-token: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # Go Security Scanning (gosec + govulncheck)
  # ============================================
  go-security:
    name: Go Security
    uses: ./.github/workflows/reusable-go-security.yml
    with:
      go-version-file: src/go.mod
      cache-dependency-path: src/go.sum
      working-directory: src

  # ============================================
  # General Security Scanning (Trivy + Trufflehog)
  # ============================================
  security-scan:
    name: Security Scan
    uses: ./.github/workflows/reusable-security-scan.yml

  # ============================================
  # Linting (Dockerfiles, Actions, Protobuf)
  # ============================================
  lint:
    name: Lint
    uses: ./.github/workflows/reusable-lint.yml
    with:
      dockerfiles: "infra/build/dockerfiles/Dockerfile infra/build/dockerfiles/Dockerfile.debug infra/build/dockerfiles/oapi-codegen.Dockerfile"
    secrets:
      github-token: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # SBOM Generation & Vulnerability Scanning
  # ============================================
  sbom:
    name: SBOM & Grype
    permissions:
      contents: read
      security-events: write
    uses: ./.github/workflows/reusable-sbom.yml
    with:
      source-path: ./src
